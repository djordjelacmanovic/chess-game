<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Game by Djordje</title>
    <link rel="stylesheet" href="css/chessboard-0.3.0.min.css"/>
</head>
<body>
<div id="board" style="width: 600px"></div>

<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript" src="js/jquery-3.1.0.min.js"></script>
<script type="text/javascript" src="js/chessboard-0.3.0.min.js"></script>
<script type="text/javascript">

    var socket = io({transports: ['websocket']});

    socket.on('message', function (message) {
        console.log(message);
    });

    window.selectedPiece = null;

    var removeGreySquares = function removeGreySquares() {
        $('#board').find('.square-55d63').css('background', '').removeClass('selected');
    };

    var greySquare = function(square) {
        var squareEl = $('#board').find('.square-' + square);

        var background = '#a9a9a9';
        if (squareEl.hasClass('black-3c85d') === true) {
            background = '#696969';
        }

        squareEl.css('background', background);
        squareEl.addClass('selected');
    };

    var board = new ChessBoard('board',{
        onMouseoverSquare: function (square, piece) {
            if(window.selectedPiece)
                return;
            removeGreySquares();

            if(!piece)
                return;

            socket.on('piece exists '+square, function (exists) {
                if(exists){
                    greySquare(square);
                    socket.on('allowed moves '+square, function (moves) {
                        moves.forEach(function (sq) {
                            greySquare(sq);
                        });
                    });

                    socket.emit('allowed moves', square);
                }
            });

            socket.emit('piece exists', square);

        },
        onMouseutSquare : function () {
            if(window.selectedPiece)
                return;
            removeGreySquares();
        }
    });

    board.start();

    socket.on('move', function (move) {
        board.move(move);
    });

    $('.square-55d63').click(function () {
        var el = jQuery(this);
        var sq = el.data('square');
        if(selectedPiece){
            if(!el.hasClass('selected'))
                return;
            var move = selectedPiece+'-'+sq;
            board.move(move);
            window.selectedPiece = null;
            socket.emit('move', move);
            return removeGreySquares();
        }
        window.selectedPiece = sq;
        console.log(selectedPiece);
        el.css('background','#cc0000');
    })
</script>
</body>
</html>