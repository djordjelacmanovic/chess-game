<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Game by Djordje</title>
    <link rel="stylesheet" href="css/chessboard-0.3.0.min.css"/>
    <style>
        .in-check{
            background: #cc0000;
        }
    </style>
</head>
<body>
<div id="board" style="width: 600px"></div>

<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript" src="js/jquery-3.1.0.min.js"></script>
<script type="text/javascript" src="js/chessboard-0.3.0.min.js"></script>
<script type="text/javascript">

    function init() {
        window.socket = io({transports: ['websocket']});

        window.socket.on('message', function (message) {
            console.log(message);
        });

        window.socket.on('move', function (move) {
            window.board.move(move);
            toggleMove();
        });

        window.socket.on('checkmate', function (color) {
           alert(color + ' defeated.');
        });

        window.socket.on('check', function (square) {
            getSquareElement(square).addClass('in-check');
        });

        window.socket.on('uncheck', function (square) {
            getSquareElement(square).removeClass('in-check');
        });

        window.socket.on('paired', function (color) {
           window.board.orientation(color);
            bindClickListeners();
        });

        window.board = new ChessBoard('board', {
            onMouseoverSquare: mouseOverSquare,
            onMouseoutSquare: function () {
                if (window.selectedPiece)
                    return;
                removeGreySquares();
            }
        });

        window.selectedPiece = null;
        window.toMove = 'white';

        window.board.start();
        bindClickListeners();
    }

    function getSquareElement(square) {
        return $('#board').find('.square-' + square);
    }

    function removeGreySquares() {
        $('#board').find('.square-55d63').css('background', '').removeClass('selected');
    }

    function greySquare(square) {
        var squareEl = getSquareElement(square);

        var background = '#a9a9a9';
        if (squareEl.hasClass('black-3c85d') === true) {
            background = '#696969';
        }

        squareEl.css('background', background);
        squareEl.addClass('selected');
    }

    function mouseOverSquare(square, piece) {
        if (window.selectedPiece)
            return;
        removeGreySquares();

        if (!piece)
            return;

        if(!isTurn()
                || piece.search(window.toMove === 'white'
                                ? /^w/
                                : /^b/
                ) === -1){
            return;
        }

        window.socket.on('piece exists ' + square, function (exists) {
            if (exists) {
                greySquare(square);
                window.socket.on('allowed moves ' + square, function (moves) {
                    moves.forEach(function (sq) {
                        greySquare(sq);
                    });
                });

                window.socket.emit('allowed moves', square);
            }
        });

        window.socket.emit('piece exists', square);

    }

    function bindClickListeners() {
        $('.square-55d63').click(function () {
            var el = jQuery(this);
            var sq = el.data('square');
            var piece = el.find('img').data('piece');
            if (window.selectedPiece) {
                if(sq === window.selectedPiece){
                    window.selectedPiece = null;
                    el.css('background', '');
                    greySquare(sq);
                    return;
                }
                if (!el.hasClass('selected'))
                    return;
                var move = window.selectedPiece + '-' + sq;
                window.board.move(move);
                window.selectedPiece = null;
                toggleMove();
                socket.emit('move', move);
                return removeGreySquares();
            }

            if( !isTurn() || piece.search(window.toMove === 'white' ? /^w/ : /^b/) === -1)
                return;
            window.selectedPiece = sq;
            console.log(window.selectedPiece);
            el.css('background', '#cc0000');
        });
    }

    function isTurn() {
        return window.toMove === window.board.orientation();
    }

    function toggleMove() {
        window.toMove = window.toMove === 'white' ? 'black' : 'white';
    }

    init();

</script>
</body>
</html>